<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="../../bower_components/paper-range-slider/paper-range-slider.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/iron-icons/device-icons.html">
<link rel="import" href="../../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../shared-styles.html">
<script type="text/javascript" src="https://d3js.org/d3.v4.min.js"></script>

<dom-module id="game-track">
  <template>
      <style include="shared-styles">
      :host {

      }

      #header {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      .game-settings {
        position: absolute;
        min-width: 700px;
        width: 50%;
        height: 50%;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        margin: auto;

        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
      }

      .difficulty-section {
        display: flex;
        flex-direction: row;
        align-items: center;
      }

      .difficulty-button {
        display: flex;
        margin: 0 20px;
        flex-direction: column;
        justify-content: space-between;
        align-items: center;
      }

      .input {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
      }

      .input span {
        display: flex;
        flex-direction: row;
        align-items: center;
      }

      .input div {
        display: flex;
        flex-direction: row;
        align-items: center;
      }

      paper-input {
        width: 75px !important;
      }

      .text-input {
        width: 210px;
        display: flex;
        flex-direction: row;
      }

      .text-input p {
        width: 20px;
        margin: 0 15px;
      }


      paper-slider {
        --paper-slider-container-color: var(--app-primary-color);
        --paper-slider-active-color: var(--app-secondary-color);
        --paper-slider-knob-color: var(--app-secondary-color);
        --paper-slider-pin-color: var(--app-secondary-color);
        --paper-slider-knob-start-color: var(--app-secondary-color);
        --paper-slider-knob-start-border-color: var(--app-primary-color);
      }

      paper-range-slider {
        --paper-range-slider-knob-color: var(--app-secondary-color);
        --paper-range-slider-pin-color:var(--app-secondary-color);
        --paper-range-slider-higher-color: var(--app-primary-color);
        --paper-range-slider-lower-color: var(--app-primary-color);
        --paper-range-slider-active-color: var(--app-secondary-color);
        --paper-range-slider-knob-start-color: var(--app-secondary-color);
        --paper-range-slider-knob-start-border-color: var(--app-primary-color);
      }

      #container {
        width: 100%;
        height: calc(100vh - 48px);
        cursor: crosshair;
        overflow: hidden;
      }

      #score {
        width: 50%;
        height: 50%;
      }

      #clickAnimation0, #clickAnimation1 {
        position: absolute;
        stroke-dasharray: 8;
        animation: pop 0.25s linear forwards;
      }


    </style>

    <div class="card game-settings" hidden$="{{gameInProgress}}">
      <div id="header">
        <iron-icon icon="hardware:mouse"></iron-icon>
        <h1>Mouse Track</h1>
      </div>
      <div class="difficulty-section">
        <div class="difficulty-button">
          <paper-icon-button icon="device:gps-off" id="noob" on-click="onDifficultyClicked"></paper-icon-button>
          <span>Noob</span>
        </div>
        <div class="difficulty-button">
          <paper-icon-button icon="device:gps-not-fixed" id="average" on-click="onDifficultyClicked"></paper-icon-button>
          <span>Average</span>
        </div>
        <div class="difficulty-button">
          <paper-icon-button icon="device:gps-fixed" id="pro" on-click="onDifficultyClicked"></paper-icon-button>
          <span>Pro</span>
        </div>
      </div>

      <div id="input-section">
        <div class="input">
          <span>Time</span>
          <div>
            <paper-slider min="10" max="300" pin value="{{time}}"></paper-slider>
            <div class="text-input">
              <paper-input min="10" max="300" no-label-float type="number" value="{{time}}"><div slot="suffix">s</div></paper-input>
            </div>
          </div>
        </div>
        <div class="input">
          <span>Max Speed</span>
          <div>
            <paper-slider min="10" max="5000" pin value="{{time}}"></paper-slider>
            <div class="text-input">
              <paper-input min="10" max="5000" no-label-float type="number" value="{{time}}"><div slot="suffix">ms</div></paper-input>
            </div>
          </div>
        </div>
        <div class="input">
          <span>Target radius</span>
          <div>
            <paper-slider min="1" max="25" pin value="{{circleRadius}}"></paper-slider>
            <div class="text-input">
              <paper-input min="1" max="25" no-label-float type="number" value="{{circleRadius}}"><div slot="suffix">px</div></paper-input>
            </div>
          </div>
        </div>
      </div>
      <paper-button class="button" on-click="start">start</paper-button>
    </div>

    <paper-dialog id="score" with-backdrop>
      <h1>Score</h1>
      <p>Total Targets: {{totalTargets}}</p>
      <p>Hits: {{hits}}</p>
      <p>Missclicks: {{missClicks}}</p>
    </paper-dialog>
    <div id="container"></div>
  </template>
  <script>

    let NoobTrack = {
      MAXSPEED: {max: 2000, min: 2000},
      CIRCLERADIUS: 25
    }

    let AverageTrack = {
      MAXSPEED: {max: 1600, min: 750},
      CIRCLERADIUS: 14
    }

    let ProTrack = {
      MAXSPEED: {max: 750, min: 500},
      CIRCLERADIUS: 5
    }

    class GameTrack extends Polymer.Element {
      static get is() { return "game-track"; }
      static get properties() {
        return {
          gameInProgress: {
            type: Boolean,
            value: false,
            notify: true
          },
          time: { type: Number, value: 60, notify: true },
          maxSpeed: { type: Number, value: AverageTrack.MAXSPEED, notify: true },
          circleRadius: { type: Number, value: AverageTrack.CIRCLERADIUS, notify: true },
        }
      }

      ready() {
        super.ready()
      }

      onDifficultyClicked(event) {
        let difficulty = event.target.id;
        event.stopPropagation();
        if (difficulty == "noob") {
          this.set("frequency", NoobTrack.MAXSPEED);
          this.set("circleRadius", NoobTrack.CIRCLERADIUS);
        } else if (difficulty == "average") {
          this.set("frequency", AverageTrack.MAXSPEED);
          this.set("circleRadius", AverageTrack.CIRCLERADIUS);
        } else if (difficulty == "pro") {
          this.set("frequency", ProTrack.MAXSPEED);
          this.set("circleRadius", ProTrack.CIRCLERADIUS);
        }
      }

      start() {
        this.gameInProgress = true;

        // Reset Score
        this.totalTargets  = 0;
        this.hits          = 0;
        this.misses        = 0;

        // Translate custom-el's props to vars
        let time           = this.time*1000; // s -> ms
        let lifeSpan       = this.lifeSpan;
        let circleRadius   = this.circleRadius;

        let animationNum   = 0;
        let pointIncrement = 100; // Specifies the granularity/increments of coordinate axes

        let container = d3.select(this.$.container);
        let margin = { top: 10, left: 10, bottom: 10, right: 10 };
        let width = container.node().offsetWidth - margin.left - margin.right;
        let height = container.node().offsetHeight - margin.top - margin.bottom;

        container.select("svg").remove();
        let svg = container.append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        let xScale = d3.scaleLinear().range([0, width - circleRadius*2]) // - circleRadius*2 to avoid center of circle going outside of svg, cutting half of it out
                                     .domain([-pointIncrement, pointIncrement]);
        let yScale = d3.scaleLinear().range([height - circleRadius*2, 0])
                                     .domain([-pointIncrement, pointIncrement]);

        let target = svg.append("circle")
            .attr("r", circleRadius)
            .attr("cx", xScale(0))
            .attr("cy", yScale(0));
            // .on("mouseover", () => {
            //
            // })
            // .on("mouseout", () => {
            //
            // })

        let movementSpeed = d3.randomUniform(10, this.maxSpeed)();
        let interval = setInterval(function() {
          let speed = d3.randomUniform(10, this.maxSpeed)();
          let x     = d3.randomUniform(-pointIncrement, pointIncrement)();
          let y     = d3.randomUniform(-pointIncrement, pointIncrement)();

          target.transition()
                .duration(speed)
                .ease(d3.easeLinear)
                .transform("translate(" + xScale(x) + "," + yScale(y) + ")");


        }.bind(this), movementSpeed);

        setTimeout(() => {
          clearInterval(interval);
          container.select("svg").remove();
          this.gameInProgress = false;
          this.$.score.open();
        }, time);
      }
    }
    window.customElements.define(GameTrack.is, GameTrack);
  </script>
</dom-module>
