<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/iron-icons/device-icons.html">
<link rel="import" href="../../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../shared-styles.html">
<script type="text/javascript" src="https://d3js.org/d3.v4.min.js"></script>

<dom-module id="game-mouse">
  <template>
      <style include="shared-styles">
      :host {

      }

      #header {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      .game-settings {
        position: absolute;
        width: 50%;
        height: 50%;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        margin: auto;

        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
      }

      .difficulty-section {
        display: flex;
        flex-direction: row;
        align-items: center;
      }

      .difficulty-button {
        display: flex;
        margin: 0 20px;
        flex-direction: column;
        justify-content: space-between;
        align-items: center;
      }

      .input {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
      }

      .input span {
        display: flex;
        flex-direction: row;
        align-items: center;
      }

      .input div {
        display: flex;
        flex-direction: row;
        align-items: center;
      }

      .input paper-input {
        width: 50px;
      }

      #container {
        width: 100%;
        height: calc(100vh - 48px);
      }


    </style>

    <div class="card game-settings" hidden$="{{gameInProgress}}">
      <div id="header">
        <iron-icon icon="hardware:mouse"></iron-icon>
        <h1>Mouse Accuracy</h1>
      </div>
      <div class="difficulty-section">
        <div class="difficulty-button">
          <paper-icon-button icon="device:gps-off" name="noob" on-click="onRadioButtonClicked"></paper-icon-button>
          <span>Noob</span>
        </div>
        <div class="difficulty-button">
          <paper-icon-button icon="device:gps-not-fixed" name="average" on-click="onRadioButtonClicked"></paper-icon-button>
          <span>Average</span>
        </div>
        <div class="difficulty-button">
          <paper-icon-button icon="device:gps-fixed" name="pro" on-click="onRadioButtonClicked"></paper-icon-button>
          <span>Pro</span>
        </div>
      </div>

      <div id="input-section">
        <div class="input">
          <span>Time (s)</span>
          <div>
            <paper-slider min="0" max="300" pin value="{{time}}"></paper-slider>
            <paper-input min="0" max="300" no-label-float type="number" value="{{time}}"></paper-input></div>
          </div>
        <div class="input">
          <span>Spawn frequency (s)</span>
          <div>
            <paper-slider min="0" max="5" pin value="{{frequency}}"></paper-slider>
            <paper-input min="0" max="5" no-label-float type="number" value="{{frequency}}"></paper-input>
          </div>
        </div>
        <div class="input">
          <span>Target lifespan (s)</span>
          <div>
            <paper-slider min="0" max="10" pin value="{{lifeSpan}}"></paper-slider>
            <paper-input min="0" max="10" no-label-float type="number" value="{{lifeSpan}}"></paper-input>
          </div>
        </div>
        <div class="input">
          <span>Target radius (px)</span>
          <div>
            <paper-slider min="0" max="25" pin value="{{circleRadius}}"></paper-slider>
            <paper-input min="0" max="25" no-label-float type="number" value="{{circleRadius}}"></paper-input>
          </div>
        </div>
      </div>
      <paper-button class="button" on-click="start">start</paper-button>
    </div>

    <div id="container"></div>
  </template>
  <script>

    class GameMouse extends Polymer.Element {
      static get is() { return "game-mouse"; }
      static get properties() {
        return {
          gameInProgress: {
            type: Boolean,
            value: false,
            notify: true
          },
          time: { type: Number, value: 20, notify: true },
          frequency: { type: Number, value: 1, notify: true },
          lifeSpan: { type: Number, value: 1, notify: true },
          circleRadius: { type: Number, value: 5, notify: true }
        }
      }

      ready() {
        super.ready()
      }

      start() {
        this.gameInProgress = true;

        let time           = this.time*1000;
        let frequency      = this.frequency*1000;
        let lifeSpan       = this.lifeSpan*1000;
        let circleRadius     = this.circleRadius;

        let pointIncrement = 100;
        let domain         = pointIncrement - this.circleRadius;

        let container = d3.select(this.$.container);
        let margin = { top: 10, left: 10, bottom: 10, right: 10 };
        let width = container.node().offsetWidth - margin.left - margin.right;
        let height = container.node().offsetHeight - margin.top - margin.bottom;

        container.select("svg").remove();
        let svg = container.append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


        let xScale = d3.scaleLinear().range([0, width])
                                     .domain([-domain, domain]);
        this.xScale = xScale;
        let yScale = d3.scaleLinear().range([height, 0])
                                     .domain([-domain, domain]);
        this.yScale = yScale;

        let interval = setInterval(function() {
          let x = d3.randomUniform(-domain, domain)();
          let y = d3.randomUniform(-domain, domain)();

          let circle = svg.append("circle")
              .attr("r", this.circleRadius)
              .attr("cx", this.xScale(x))
              .attr("cy", this.yScale(y));

          setTimeout(() => {
            circle.remove();
          }, lifeSpan);
        }.bind(this), frequency);

        setTimeout(() => {
          clearInterval(interval);
          container.select("svg").remove();
          this.gameInProgress = false;
        }, time);
      }
    }
    window.customElements.define(GameMouse.is, GameMouse);
  </script>
</dom-module>
